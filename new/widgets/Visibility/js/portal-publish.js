// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Visibility/templates/portal-publish.html":'\x3cdiv class\x3d"esriCTFullHeight" data-dojo-attach-point\x3d"resultsPageNode"\x3e\r\n    \x3cdiv class\x3d"esriCTFullWidth esriCTSettingHeader"\x3e\r\n      \x3cdiv class\x3d"esriCTBackButton" title\x3d"${nls.back}"\x3e\r\n        \x3cdiv class\x3d"esriCTItemLeftArrow" data-dojo-attach-point\x3d"resultsPanelBackButton" tabindex\x3d"0" aria-label\x3d"${nls.back}" role\x3d"button"\x3e\x3c/div\x3e\r\n        \x3cdiv class\x3d"esriCTTitleDiv esriCTEllipsis" title\x3d"${nls.resultsTitle}"\x3e${nls.resultsTitle}\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"esriCTMainPageRow"\x3e\r\n        \x3c!-- esriCT Layer Name --\x3e\r\n        \x3cdiv class\x3d"esriCTFullWidth esriCTSettingRow"\x3e\r\n          \x3cdiv class\x3d"esriCTInputLabel esriCTEllipsis" title\x3d"${nls.layerName}"\x3e${nls.layerName}\x3c/div\x3e\r\n          \x3cinput aria-label\x3d"${nls.layerName}" class\x3d"esriCTHidden" style\x3d"width: 100%; margin-bottom: 8px;" data-dojo-type\x3d"dijit/form/ValidationTextBox"\r\n            data-dojo-attach-point\x3d"addLayerNameArea" data-dojo-props\x3d"regExp:\'[a-zA-Z0-9_ -]*\', invalidMessage:\'${nls.invalidLayerName}\', missingMessage:\'${nls.missingLayerName}\'"\r\n            required\x3d"true" tabindex\x3d"0" \x3e\x3c/input\x3e\r\n            \x3cselect class\x3d"SelectStyle" aria-label\x3d"${nls.layerName}" data-dojo-type\x3d"jimu/dijit/formSelect" tabindex\x3d"0" data-dojo-attach-point\x3d"featureLayerList"\x3e\x3c/select\x3e\r\n            \x3cdiv class\x3d"esriCTCheckBoxNode" data-dojo-attach-point\x3d"checkBoxParentContainer"\x3e\x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Publish esriCT Button --\x3e\r\n        \x3cdiv class\x3d"esriCTPublishBtnContainer"\x3e\r\n          \x3cdiv class\x3d\'jimu-btn\' data-dojo-attach-point\x3d\'publishButton\' tabindex\x3d"0" aria-label\x3d"${nls.publishBtnLabel}" role\x3d"button"\x3e${nls.publishBtnLabel}\x3c/div\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3c!-- Publishing Message --\x3e\r\n        \x3cdiv class\x3d"esriCTPublishMessage" data-dojo-attach-point\x3d"publishMessage"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dijit/_WidgetsInTemplateMixin jimu/dijit/CheckBox dojo/_base/array dojo/_base/lang dojo/text!../templates/portal-publish.html dojo/dom-construct dojo/on dojo/dom-class jimu/utils esri/IdentityManager esri/arcgis/Portal dojo/Evented ./portal-utils jimu/LayerInfos/LayerInfos esri/layers/FeatureLayer esri/graphic esri/dijit/util/busyIndicator jimu/utils dojo/keys dijit/focus dojo/query dojo/topic dijit/form/ValidationTextBox jimu/dijit/formSelect".split(" "),
function(w,x,y,z,g,b,A,B,k,c,C,n,D,E,l,t,u,p,F,q,m,r,G,H){return w([x,y,E],{templateString:A,baseClass:"jimu-widget-visibility-publish",publishNewLayer:null,busyIndicator:null,fieldsObj:null,postCreate:function(){String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,d){return"undefined"!==typeof a[d]?a[d]:b})});this.fieldsObj={RegionType:{value:"",dataType:"esriFieldTypeInteger"},CenterPoint:{value:this.centerPoint,dataType:"esriFieldTypeString"},
ObservationHeight:{value:this.observerHeight,dataType:"esriFieldTypeDouble"},HeightUnit:{value:this.observerHeightDD,dataType:"esriFieldTypeString"},MinObservationDistance:{value:this.minObsRange,dataType:"esriFieldTypeDouble"},MaxObservationDistance:{value:this.maxObsRange,dataType:"esriFieldTypeDouble"},DistanceUnit:{value:this.distanceUnitDD,dataType:"esriFieldTypeString"},FOVStartAngle:{value:this.fovStartAngle,dataType:"esriFieldTypeDouble"},FOVEndAngle:{value:this.fovEndAngle,dataType:"esriFieldTypeDouble"},
AngleUnits:{value:this.angleUnits,dataType:"esriFieldTypeString"}};this.fields={RegionType:"",CenterPoint:this.centerPoint,ObservationHeight:this.observerHeight,HeightUnit:this.observerHeightDD,MinObservationDistance:this.minObsRange,MaxObservationDistance:this.maxObsRange,DistanceUnit:this.distanceUnitDD,FOVStartAngle:this.fovStartAngle,FOVEndAngle:this.fovEndAngle,AngleUnits:this.angleUnits};this.publishNewLayer=new z({checked:!1,label:this.nls.publishToNewLayer},B.create("div",{},this.checkBoxParentContainer));
this.own(k(this.publishNewLayer,"change",b.hitch(this,this._onCheckboxClicked)));this._populateSelectList(this.featureLayerList,this._layerList,!0);!this.config.hasOwnProperty("operationalLayer")||this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""===this.config.operationalLayer.name?(c.add(this.featureLayerList.domNode,"esriCTHidden"),this.publishNewLayer.setValue(!0),c.remove(this.addLayerNameArea.domNode,"esriCTHidden")):(c.remove(this.featureLayerList.domNode,
"esriCTHidden"),this.publishNewLayer.setValue(!1),c.add(this.addLayerNameArea.domNode,"esriCTHidden"));this.own(k(this.resultsPanelBackButton,"click",b.hitch(this,function(){this.emit("displayMainPageOnBack")})));this.own(k(this.resultsPanelBackButton,"keydown",b.hitch(this,function(a){a.keyCode!==m.ENTER&&a.keyCode!==m.SPACE||this.emit("displayMainPageOnBack")})));this.own(k(this.publishButton,"click",b.hitch(this,function(){if(this.publishNewLayer.checked&&!this.addLayerNameArea.isValid())this.publishMessage.innerHTML=
this.nls.missingLayerNameMessage;else{var a=this.publishNewLayer.checked?this.addLayerNameArea.value:this.featureLayerList.get("value");this.publishMessage.innerHTML="";this._initSaveToPortal(a)}})));this.own(k(this.publishButton,"keydown",b.hitch(this,function(a){if(a.keyCode===m.ENTER||a.keyCode===m.SPACE)this.publishNewLayer.checked&&!this.addLayerNameArea.isValid()?(this.publishMessage.innerHTML=this.nls.missingLayerNameMessage,this._setFirstLastFocusNodes()):(a=this.publishNewLayer.checked?this.addLayerNameArea.value:
this.featureLayerList.get("value"),this.publishMessage.innerHTML="",this._initSaveToPortal(a))})))},startup:function(){this.busyIndicator=F.create({target:this.parentNode.parentNode.parentNode.parentNode,backgroundOpacity:0})},_onCheckboxClicked:function(){this.publishNewLayer.checked?(c.add(this.featureLayerList.domNode,"esriCTHidden"),c.remove(this.addLayerNameArea.domNode,"esriCTHidden"),this.addLayerNameArea.reset(),this.addLayerNameArea.focus()):(c.add(this.addLayerNameArea.domNode,"esriCTHidden"),
c.remove(this.featureLayerList.domNode,"esriCTHidden"));this._addLayerToMap=this.publishNewLayer.checked},_populateSelectList:function(a,e,d){var f=[];d&&(f=g.filter(e,function(a){return"esriGeometryPolygon"===a.geometryType},this));e=0<f.length?f:e;g.forEach(e,b.hitch(this,function(b){a.addOption({value:b.name,label:C.sanitizeHTML(b.name),selected:!1,id:b.id})}));this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""!==this.config.operationalLayer.name?
a.setValue(this.config.operationalLayer.name):a.setValue("")},_initSaveToPortal:function(a){n.registerOAuthInfos();n.getCredential(this.appConfig.portalUrl+"/sharing",{oAuthPopupConfirmation:!1}).then(b.hitch(this,function(){var e=new D.Portal(this.appConfig.portalUrl);e.signIn().then(b.hitch(this,function(d){var f=d.credential.token,I=d.orgId,v=d.username;if("org_user"===d.role)this.publishMessage.innerHTML=this.nls.createService.format(this.nls.userRole),this._setFirstLastFocusNodes();else{var c=
this.appConfig.portalUrl+"sharing/content/users/"+v+"/createService";l.isNameAvailable(this.appConfig.portalUrl+"sharing/rest/portals/"+I+"/isServiceNameAvailable",f,a).then(b.hitch(this,function(d){d.available?(this.busyIndicator.show(),l.createFeatureService(c,f,l.getFeatureServiceParams(a,this.map)).then(b.hitch(this,function(d){if(d.success){var c=d.serviceurl.replace(/rest/g,"rest/admin")+"/addToDefinition";l.addDefinitionToService(c,f,l.getLayerParams(a,this.map,this._renderer,this.nls)).then(b.hitch(this,
function(h){if(h.success){h=new u(d.serviceurl+"/0?token\x3d"+f,{id:a,outFields:["*"]});h._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:d.itemId}};this.map.addLayer(h);var c;if(h.loaded)c=t.getInstanceSync().getLayerInfoById(a),c.enablePopup();else h.on("load",b.hitch(this,function(){c=t.getInstanceSync().getLayerInfoById(a);c.enablePopup()}));var e=[];g.forEach(this.graphics,function(a){if(void 0!==a.attributes&&a.attributes.hasOwnProperty("type")){var d=b.clone(this.fields);
d.RegionType=a.attributes.type;e.push(new p(a.geometry,null,d))}},this);h.applyEdits(e,null,null).then(b.hitch(this,function(){this._reset()})).otherwise(b.hitch(this,function(){this._reset()}));this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca role\x3d"link" tabindex\x3d0 aria-label\x3d"'+this.nls.successfullyPublished+'" href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+d.itemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._setFirstLastFocusNodes()}}),
b.hitch(this,function(a){this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.addToDefinition.format(a.message);this._setFirstLastFocusNodes()}))}else this.busyIndicator.hide(),this.publishMessage.innerHTML=this.nls.unableToCreate.format(a),this._setFirstLastFocusNodes()}),b.hitch(this,function(a){this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.createService.format(a.message);this._setFirstLastFocusNodes()}))):(e.queryItems({q:"name:"+a+" AND owner:"+v}).then(b.hitch(this,
function(d){if(0<d.results.length){var c=g.map(d.results,function(b){if(b.name===a)return b},this),e=new u(c[0].url+"/0?token\x3d"+f,{id:a,outFields:["*"]});e._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:c[0].id}};e.on("load",b.hitch(this,function(a){var d=[];g.forEach(this.graphics,function(b){if(void 0!==b.attributes&&b.attributes.hasOwnProperty("type")){var c=this._matchLayerFields(b.attributes.type,a.layer._fields);0<Object.keys(c).length?d.push(new p(b.geometry,null,
c)):d.push(new p(b.geometry,null,{}))}},this);e.applyEdits(d,null,null).then(b.hitch(this,function(){this._reset()})).otherwise(b.hitch(this,function(){this._reset()}));H.publish("moveMap",!1);this.publishMessage.innerHTML=this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+c[0].id+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._setFirstLastFocusNodes()}))}}),b.hitch(this,function(){this.publishMessage.innerHTML=this.nls.addToDefinition.format(a)})),
this._setFirstLastFocusNodes())}),b.hitch(this,function(a){this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.checkService.format(a.message);this._setFirstLastFocusNodes()}))}}),b.hitch(this,function(a){this.publishMessage.innerHTML=a.message;this._setFirstLastFocusNodes()}))}));n.destroyCredentials()},_reset:function(){this.graphicsLayer.clear();this.graphics=[];this.graphicsLayer.refresh()},_setFirstLastFocusNodes:function(){q.initFirstFocusNode(this.parentNode,this.resultsPanelBackButton);
r.focus(this.resultsPanelBackButton);q.initLastFocusNode(this.parentNode,this.publishButton);var a=G("a",this.publishMessage)[0];""!==this.publishMessage.innerHTML&&a?(q.initLastFocusNode(this.parentNode,this.publishMessage),r.focus(a)):""===this.publishMessage.innerHTML&&r.focus(this.resultsPanelBackButton)},_matchLayerFields:function(a,c){var d={},e=Object.keys(this.fieldsObj);g.forEach(c,b.hitch(this,function(c){g.forEach(e,b.hitch(this,function(b){if(c.name.toLowerCase()===b.toLowerCase()&&(c.type===
this.fieldsObj[b].dataType||"esriFieldTypeString"===c.type)){var e=this.fieldsObj[b].value;"esriFieldTypeString"===c.type&&50>c.length&&"string"===typeof this.fieldsObj[b].value&&(e=this.fieldsObj[b].value.substr(0,c.length));d[c.name]="RegionType"===b?a:e}}))}));return d}})});